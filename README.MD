# Kodik-Download-Watch

## Описание
Небольшое Flask приложение для скачивания и просмотра аниме/дорам из базы Kodik. Также возможно создание комнат для совместного просмотра.

## Технологии
* Python
* Flask
* BeautifulSoup4
* Jinja2

В качестве парсеров библиотека [anime_parser_ru](https://github.com/YaNesyTortiK/AnimeParsers) (Самописная, чтобы было проще фиксить парсеры)

## Как запустить

0. Убедитесь что у вас установлена версия python >= 3.10.11 (На более ранних версиях тестирование не проводилось)
1. Склонируйте репозиторий
2. Создайте и активируйте виртуальное окружение
Windows:
```commandline
python -m venv venv
venv/Scripts/activate
```  
Linux:
```commandline
python3 -m venv venv
source venv/bin/activate
```  
3. Установите зависимости
Windows:
```commandline
pip install -r requirements.txt
```
Linux:
```commandline
pip3 install -r requirements.txt
```
Для работы некоторых функции может потребоваться установить ffmpeg. (необязательно)

4. Настройте конфигурацию программы в файле config.py
* Измените APP_SECRET_KEY
* Выберите, будете ли вы кешировать данные из поиска. (Ускоряет работу программы, за счёт снижения количества запросов на сторонние сервисы, однако расходует память устройства)
    - SAVE_DATA - сохранять новые данные (По умолчанию True)
    - USE_SAVED_DATA - использовать уже сохранённые данные (По умолчанию True)
    - SAVED_DATA_FILE - имя файла (json) для хранения данных (обязательно наличие этого файла если хотя-бы один из выше перечисленных параметров установлен в True) (По умолчанию "cache.json")
    - SAVING_PERIOD - как часто (в минутах) данные будут перезаписываться в файл (По умолчанию 5)
    - CACHE_LIFE_TIME - как часто (в днях) данные будут сброшены и перезаписаны (По умолчанию 3)
    - Важно! Данные будут записываться, сохраняться и перезаписываться ТОЛЬКО когда программа получит такие данные в следствии запроса пользователя. К примеру, при  CACHE_LIFE_TIME = 3 (дня), если никто не будет запрашивать данные у которых превышен этот лимит, данные не удаляться и не перезапишутся даже по прошествии 5 дней. Также и с SAVING_PERIOD, сохранение будет произведено только в момент каких-либо манипуляций с данными находящимися в оперативной памяти.
* Другие настройки программы
    - KODIK_TOKEN - в данной поле можно указать строку с вашим токеном (прим: "123token"). Если оставить по умолчанию None, то программа автоматически найдет токен и будет использовать его. 
    > [!IMPORTANT]
    > В связи с блокировкой некоторых функций апи кодика для токена получаемого автоматически, если KODIK_TOKEN указан как None, то поиск будет происходить через Шикимори
    - ALLOW_WATCH_TOGETHER - включена ли функция совместного просмотра (фактически этот параметр отвечает за появление кнопки "Смотреть вместе"). При использовании этой функции рекомендуется включить кеширование, в противном случае для каждого пользователя будет проходить поиск видео отдельно. (По умолчанию True)
    - REMOVE_TIME - как долго (в минутах) будет существовать неактивная комната совместного просмотра. (По умолчанию 5)
    - ALLOW_NSFW - если True, будет использоваться shikimori api (с помощью ShikimoriParser.deep_search) в случае, если стандартный запрос будет заблокирован фильтром по возрасту. (по умолчанию True)
    - HOST - ip адрес сервера (по умолчанию 0.0.0.0 что позволяет подключаться как через 127.0.0.1, так и через локальный адрес в сети, что позволяет прдключаться с других устройств в этой сети)
    - PORT - порт сервера (по умолчанию 5000). (Если вы хотите получать досутп по чистому ip адресу, установите этот параметр в 80)
    - USE_LXML - позволяет указать использовать парсер lxml или нет (по умолчанию True) (в некоторых случаях парсер может не работать, поэтому добавлен этот параметр)

5. Запустите файл main.py
```commandline
python main.py
```
6. Перейдите в браузере по адресу
`127.0.0.1:5000` или по локальному ip адресу (указав порт). (Если порт установлен в `80` он подставляется автоматически)
## Как пользоваться сайтом

1. Найдите требуемый тайтл/сериал/фильм:
- Через поиск по базе Kodik (займёт некоторое время для обработки)
- Через поиск по id шикимори (подробную инструкцию см. ниже)
- Через поиск по id кинопоиска (подробную инструкцию см. ниже)

2. Выберите озвучку
3. Выберите серию для просмотра/загрузки
4. Для совместного просмотра нажмите соответствующую кнопку и поделитесь ссылкой с друзьями

## Важные особенности сайта
- Количество серий определяется по максимальному числу переведенных/имеющих субтитры серий. Если для выбранной озвучки нет следующей серии, но количество максимально переведенных/имеющих субтитры серий больше, то при переходе на следующую серию будет проигрываться предыдущая.
- Если при попытке загрузки возникает ошибка 404, попробуйте выбрать другое качество видео (т.к. некоторые более старые видео могут быть ниже 720p)
- Если при попытке просмотра видео будет не найдено, также попробуйте изменить качество
- Для ускорения работы программы фильмы и сериалы не имеющие shikimori id в базе Kodik'а будут без постеров и доп. информации
- В некоторых ситуациях сайт не сможет получить данные если у вас включен VPN. Если вы получили ошику что по данному запросу нет данных, попробуйте отключить VPN и попробовать снова (скорее всего проблема в плеере kodik)
- Для использовании функции быстрой загрузки необходимо установить ffmpeg (и удостовериться что к нему можно получить досутп из терминала) (Для предзагрузки ~25 минутной серии потребуется от 20-30 секунд, для презагрузки ~1.5 часового фильма потребуется 2-3 минуты)

## Удобные шорткаты при просмотре:
(не работает при совместном просмотре)
- f - вход/выход из полноэкранного режима
- m - вкл/выкл звук плеера
- d - перемотать вперед на 1:20
- a - перемотать назад на 1:20
- j - предыдущая серия
- l - следующая серия

## Совместный просмотр
Функция совместного просмотра позволяет создать публичную комнату, куда можно зайти по ссылке. Все пользователи комнаты могут ставить плеер на паузу, снимать с паузы, менять проигрываемую серию и качество просмотра. Данные изменения будут также применены и к другим пользователям комнаты. (Примерная задержка воспроизведения у разных пользователей меньше 1 секунды, однако требуется проверка с большей нагрузкой) Также при перемотке, паузе и воспроизведении плеер будет автоматически синхронизироваться с тем пользователем, который произвёл изменения.
### Релизация совместного просмотра
FrontEnd: WebSocket<br>
BackEnd: Flask-SocketIO

## Как узнать id тайтла на Шикимори
1. Зайдите на сайт <a href='shikimori.one'>Шикимори</a> и найдите там страницу требуемого сезона/фильма.
2. В адресной строке браузера будет виден id
- Примеры: <p>
    https://shikimori.one/animes/z20-naruto<br>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^^^<br>
    В данном случае id будет "z20"<br><br>
    https://shikimori.one/animes/29803-overlord<br>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^^^^^<br>
    В данном случае id будет "29803"</p>
3. Теперь можно подставлять полученный id в соответствующую поисковую строку

## Как узнать id тайтла на Кинопоиске
1. Зайдите на сайт <a href='https://www.kinopoisk.ru'>Кинопоиска</a> и найдите там страницу требуемого сериала/фильма.
2. В адресной строке браузера будет виден id
- Примеры: <p>
    https://www.kinopoisk.ru/series/749374/<br>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^^^^^<br>
    В данном случае id будет "749374"<br><br>
    https://www.kinopoisk.ru/series/1220920/<br>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;^^^^^<br>
    В данном случае id будет "1220920"</p>
3. Теперь можно подставлять полученный id в соответствующую поисковую строку

### Про токен
Если вы не указали свой токен в файле `config.py`, то программа будет использовать встроенную возможность библиотеки anime-parsers-ru для автоопределения токена. Данный токен находится в одном из открытых для загрузки скриптов.